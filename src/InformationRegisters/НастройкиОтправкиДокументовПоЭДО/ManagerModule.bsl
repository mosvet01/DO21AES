
#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ОбработкаПереходаНаНовуюВерсию

Процедура ЗаполнитьВидДокументаЭДОВПравилахОтправки(Параметры) Экспорт
	
	МетаданныеОбъекта = Метаданные.РегистрыСведений.НастройкиОтправкиДокументовПоЭДО;
	ПолноеИмяОбъекта = МетаданныеОбъекта.ПолноеИмя();
	
	Если ОбновлениеИнформационнойБазы.ЕстьЗаблокированныеПредыдущимиОчередямиДанные(Параметры.Очередь, "Справочник.ВидыДокументовЭДО") Тогда
		Параметры.ОбработкаЗавершена = ОбновлениеИнформационнойБазы.ОбработкаДанныхЗавершена(
			Параметры.Очередь, ПолноеИмяОбъекта);
		Возврат;
	КонецЕсли;
	
	ПараметрыОтметкиВыполнения = ОбновлениеИнформационнойБазы.ДополнительныеПараметрыОтметкиОбработки();
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	НастройкиОтправкиДокументовПоЭДО.Отправитель,
	|	НастройкиОтправкиДокументовПоЭДО.Получатель,
	|	НастройкиОтправкиДокументовПоЭДО.ВидДокумента,
	|	НастройкиОтправкиДокументовПоЭДО.ВидДокументаЭДО,
	|	НастройкиОтправкиДокументовПоЭДО.УдалитьВидЭД,
	|	НастройкиОтправкиДокументовПоЭДО.УдалитьТипЭД
	|ИЗ
	|	РегистрСведений.НастройкиОтправкиДокументовПоЭДО КАК НастройкиОтправкиДокументовПоЭДО
	|ГДЕ
	|	НастройкиОтправкиДокументовПоЭДО.ВидДокументаЭДО = ЗНАЧЕНИЕ(Справочник.ВидыДокументовЭДО.ПустаяСсылка)
	|	И НастройкиОтправкиДокументовПоЭДО.УдалитьВидЭД <> ЗНАЧЕНИЕ(Перечисление.ТипыДокументовЭДО.ПустаяСсылка)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	НастройкиОтправкиДокументовПоЭДО.Отправитель,
	|	НастройкиОтправкиДокументовПоЭДО.Получатель,
	|	НастройкиОтправкиДокументовПоЭДО.ВидДокумента,
	|	НастройкиОтправкиДокументовПоЭДО.ВидДокументаЭДО,
	|	НастройкиОтправкиДокументовПоЭДО.УдалитьВидЭД,
	|	НастройкиОтправкиДокументовПоЭДО.УдалитьТипЭД
	|ИЗ
	|	РегистрСведений.НастройкиОтправкиДокументовПоЭДО КАК НастройкиОтправкиДокументовПоЭДО
	|ГДЕ
	|	НастройкиОтправкиДокументовПоЭДО.ВидДокументаЭДО = ЗНАЧЕНИЕ(Справочник.ВидыДокументовЭДО.ПустаяСсылка)
	|	И НастройкиОтправкиДокументовПоЭДО.УдалитьВидЭД = ЗНАЧЕНИЕ(Перечисление.ТипыДокументовЭДО.ПустаяСсылка)
	|	И
	|		НастройкиОтправкиДокументовПоЭДО.УдалитьТипЭД <> ЗНАЧЕНИЕ(Перечисление.УдалитьТипыПроизвольныхДокументовЭДО.ПустаяСсылка)";
	
	ВыборкаДанных = Запрос.Выполнить().Выбрать();
	
	ОбъектовКОбработке = ВыборкаДанных.Количество();
	
	СоответствиеВидовДокументов = ОбменСКонтрагентамиИнтеграция.СоответствиеВидовЭДВидамДокументовЭДО();
	
	ОбъектовОбработано = 0;
	ПроблемныхОбъектов = 0;
	
	Пока ВыборкаДанных.Следующий() Цикл
		
		НачатьТранзакцию();
		Попытка
			
			Записать = Ложь;
			
			НаборЗаписей = РегистрыСведений.НастройкиОтправкиДокументовПоЭДО.СоздатьНаборЗаписей();
			НаборЗаписей.Отбор.Отправитель.Установить(ВыборкаДанных.Отправитель);
			НаборЗаписей.Отбор.Получатель.Установить(ВыборкаДанных.Получатель);
			НаборЗаписей.Отбор.ВидДокумента.Установить(ВыборкаДанных.ВидДокумента);
			ОбщегоНазначенияБЭД.УстановитьУправляемуюБлокировкуПоНаборуЗаписей(НаборЗаписей);
			
			НаборЗаписей.Прочитать();
			
			Если НаборЗаписей.Количество() Тогда
				
				ЗаполнитьВидДокументаЭДОПриОбновлении(
					НаборЗаписей,
					СоответствиеВидовДокументов,
					Записать);
				
			КонецЕсли;
			
			Если Записать Тогда
				ОбновлениеИнформационнойБазы.ЗаписатьНаборЗаписей(НаборЗаписей);
			Иначе
				ОбновлениеИнформационнойБазы.ОтметитьВыполнениеОбработки(НаборЗаписей, ПараметрыОтметкиВыполнения);
			КонецЕсли;
			
			ОбъектовОбработано = ОбъектовОбработано + 1;
			
			ЗафиксироватьТранзакцию();
		Исключение
			ОтменитьТранзакцию();
			
			ПроблемныхОбъектов = ПроблемныхОбъектов + 1;
			
			ТекстСообщения = СтрШаблон(НСтр("ru = 'Не удалось обработать настройки отправки документов по ЭДО для: %1 по причине:
				|%2'"), ВыборкаДанных.Отправитель, ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
			ЗаписьЖурналаРегистрации(ОбновлениеИнформационнойБазы.СобытиеЖурналаРегистрации(),
				УровеньЖурналаРегистрации.Ошибка, МетаданныеОбъекта, ВыборкаДанных.Ссылка, ТекстСообщения);
		КонецПопытки;
		
	КонецЦикла;
	
	Если ОбъектовОбработано = 0 И ПроблемныхОбъектов <> 0 Тогда
		ШаблонСообщения = НСтр("ru = 'Не удалось обработать некоторые настройки отправки по ЭДО (пропущены): %1'");
		ТекстСообщения = СтрШаблон(ШаблонСообщения, ПроблемныхОбъектов);
		ВызватьИсключение ТекстСообщения;
	Иначе
		ШаблонСообщения = НСтр("ru = 'Обработана очередная порция настроек отправки по ЭДО: %1'");
		ТекстСообщения = СтрШаблон(ШаблонСообщения, ОбъектовОбработано);
		ЗаписьЖурналаРегистрации(ОбновлениеИнформационнойБазы.СобытиеЖурналаРегистрации(),
			УровеньЖурналаРегистрации.Информация,
			МетаданныеОбъекта,, ТекстСообщения);
	КонецЕсли;
	
	Параметры.ПрогрессВыполнения.ОбработаноОбъектов =
		Параметры.ПрогрессВыполнения.ОбработаноОбъектов + ОбъектовОбработано;
	
	Параметры.ОбработкаЗавершена = ОбъектовКОбработке <= ОбъектовОбработано;
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныйПрограммныйИнтерфейс

// Возвращает настройки отправи внутненних документов по ЭДО.
// 
// Параметры:
//   Организация - Справочник.Организации - Организация для которой необходимо получить правила отправки.
//   Контрагент - Справочник.Контрагенты - Контрагент правил.
// 
// Возвращаемое значение:
//  Таблица значений:
//      * Отправитель - Справочник.Организации - Организация.
//      * Получатель - Справочник.Контрагенты - Контрагент.
//      * ВидДокумента - Справочник.ВидыВнутреннихДокументов - Вид внутреннего документа.
//      * Отправлять - Булево - возможно ли отправлять по ЭДО этот вид документов.
//      * ВидДокументаЭДО - Справочник.ВидыДокументовЭДО - Вид документа, которым будет отправлен документ.
//      * ВидЭД - Перечисление.ВидыЭД - Вид ЭД, которым будет отправлен документ.
//      * ТипЭД - Перечисление.ТипыЭД - Тип ЭД, которым будет отправлен документ.
//      * ТребуетсяОтветнаяПодпись - Булево - Требовать ответную подпись.
//      * ТребуетсяИзвещениеОПолучении - Булево - Требовать извещение о получении.
Функция НастройкиОтправкиДокументовПоЭДО(Организация, Контрагент) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	ОписаниеТипаБулево = Новый ОписаниеТипов("Булево");
	ОписаниеТипаФормата = Новый ОписаниеТипов("Строка", , , , Новый КвалификаторыСтроки(50));
	
	ИсходящиеДокументы = Новый ТаблицаЗначений;
	
	ИсходящиеДокументы.Колонки.Добавить("Отправитель"                  , Метаданные.ОпределяемыеТипы.Организация.Тип);
	ИсходящиеДокументы.Колонки.Добавить("Получатель"                   , Метаданные.ОпределяемыеТипы.УчастникЭДО.Тип);
	ИсходящиеДокументы.Колонки.Добавить("ВидДокумента"                 , Новый ОписаниеТипов("СправочникСсылка.ВидыВнутреннихДокументов"));
	
	ИсходящиеДокументы.Колонки.Добавить("Отправлять"                   , ОписаниеТипаБулево);
	ИсходящиеДокументы.Колонки.Добавить("ВидДокументаЭДО"              , Новый ОписаниеТипов("СправочникСсылка.ВидыДокументовЭДО"));
	ИсходящиеДокументы.Колонки.Добавить("ВидЭД"                        , Новый ОписаниеТипов("ПеречислениеСсылка.ТипыДокументовЭДО"));
	ИсходящиеДокументы.Колонки.Добавить("ТипЭД"                        , Новый ОписаниеТипов("ПеречислениеСсылка.УдалитьТипыПроизвольныхДокументовЭДО"));
	ИсходящиеДокументы.Колонки.Добавить("ТребуетсяОтветнаяПодпись"     , ОписаниеТипаБулево);
	ИсходящиеДокументы.Колонки.Добавить("ТребуетсяИзвещениеОПолучении" , ОписаниеТипаБулево);
	ИсходящиеДокументы.Колонки.Добавить("Формат"                       , ОписаниеТипаФормата);
	
	ВидыДокументов = ОбменСКонтрагентамиДОСлужебный.ВидыДокументовДляОтправкиПоЭДО();
	
	Для Каждого ВидДокумента Из ВидыДокументов Цикл
		НоваяСтрока = ИсходящиеДокументы.Добавить();
		
		НоваяСтрока.Отправитель = Организация;
		НоваяСтрока.Получатель = Контрагент;
		НоваяСтрока.ВидДокумента = ВидДокумента;
		
		НоваяСтрока.Отправлять = Ложь;
		НоваяСтрока.ВидДокументаЭДО = Справочники.ВидыДокументовЭДО.ПустаяСсылка();
		НоваяСтрока.ВидЭД = Перечисления.ТипыДокументовЭДО.ПустаяСсылка();
		НоваяСтрока.ТипЭД = Перечисления.УдалитьТипыПроизвольныхДокументовЭДО.Прочее;
		НоваяСтрока.ТребуетсяОтветнаяПодпись = Истина;
		НоваяСтрока.ТребуетсяИзвещениеОПолучении = Истина;
		НоваяСтрока.Формат = "";
	КонецЦикла;
	
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ
		|	НастройкиОтправкиДокументовПоЭДО.ВидДокумента КАК ВидДокумента,
		|	НастройкиОтправкиДокументовПоЭДО.Отправлять КАК Отправлять,
		|	НастройкиОтправкиДокументовПоЭДО.ВидДокументаЭДО КАК ВидДокументаЭДО,
		|	НастройкиОтправкиДокументовПоЭДО.УдалитьВидЭД КАК ВидЭД,
		|	НастройкиОтправкиДокументовПоЭДО.УдалитьТипЭД КАК ТипЭД,
		|	НастройкиОтправкиДокументовПоЭДО.ТребуетсяОтветнаяПодпись КАК ТребуетсяОтветнаяПодпись,
		|	НастройкиОтправкиДокументовПоЭДО.ТребуетсяИзвещениеОПолучении КАК ТребуетсяИзвещениеОПолучении,
		|	НастройкиОтправкиДокументовПоЭДО.Формат КАК Формат
		|ИЗ
		|	РегистрСведений.НастройкиОтправкиДокументовПоЭДО КАК НастройкиОтправкиДокументовПоЭДО
		|ГДЕ
		|	НастройкиОтправкиДокументовПоЭДО.Отправитель = &Организация
		|	И НастройкиОтправкиДокументовПоЭДО.Получатель = &Контрагент";
	
	Запрос.УстановитьПараметр("Организация", Организация);
	Запрос.УстановитьПараметр("Контрагент", Контрагент);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		
		Отбор = Новый Структура("ВидДокумента", Выборка.ВидДокумента);
		СтрокиНастроек = ИсходящиеДокументы.НайтиСтроки(Отбор);
		
		Для Каждого СтрокаНастроек Из СтрокиНастроек Цикл
			ЗаполнитьЗначенияСвойств(СтрокаНастроек, Выборка, , "ВидДокумента");
		КонецЦикла;
		
	КонецЦикла;
	
	Возврат ИсходящиеДокументы;
	
КонецФункции

Функция НастройкиОтправкиВидаДокумента(Организация, Контрагент, ВидДокумента) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ
		|	НастройкиОтправкиДокументовПоЭДО.ВидДокументаЭДО КАК ВидДокументаЭДО,
		|	НастройкиОтправкиДокументовПоЭДО.УдалитьВидЭД КАК ВидЭД,
		|	НастройкиОтправкиДокументовПоЭДО.УдалитьТипЭД КАК ТипЭД,
		|	НастройкиОтправкиДокументовПоЭДО.ТребуетсяОтветнаяПодпись КАК ТребуетсяОтветнаяПодпись,
		|	НастройкиОтправкиДокументовПоЭДО.ТребуетсяИзвещениеОПолучении КАК ТребуетсяИзвещениеОПолучении,
		|	ЕСТЬNULL(ВидыДокументовЭДО.ТипДокумента, ЗНАЧЕНИЕ(Перечисление.ТипыДокументовЭДО.ПустаяСсылка)) КАК ТипДокумента,
		|	НастройкиОтправкиДокументовПоЭДО.Формат КАК Формат
		|ИЗ
		|	РегистрСведений.НастройкиОтправкиДокументовПоЭДО КАК НастройкиОтправкиДокументовПоЭДО
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВидыДокументовЭДО КАК ВидыДокументовЭДО
		|		ПО НастройкиОтправкиДокументовПоЭДО.ВидДокументаЭДО = ВидыДокументовЭДО.Ссылка
		|ГДЕ
		|	НастройкиОтправкиДокументовПоЭДО.Отправитель = &Организация
		|	И НастройкиОтправкиДокументовПоЭДО.Получатель = &Контрагент
		|	И НастройкиОтправкиДокументовПоЭДО.ВидДокумента = &ВидДокумента
		|	И НастройкиОтправкиДокументовПоЭДО.Отправлять";
	
	Запрос.УстановитьПараметр("Организация", Организация);
	Запрос.УстановитьПараметр("Контрагент", Контрагент);
	Запрос.УстановитьПараметр("ВидДокумента", ВидДокумента);
	
	УстановитьПривилегированныйРежим(Истина);
	Выборка = Запрос.Выполнить().Выбрать();
	УстановитьПривилегированныйРежим(Ложь);
	
	Если Выборка.Следующий() Тогда
		
		НастройкиОтправки = Новый Структура("ВидДокументаЭДО, ВидЭД, ТипЭД, ТребуетсяОтветнаяПодпись,
			|ТребуетсяИзвещениеОПолучении, ТипДокумента, Формат");
		ЗаполнитьЗначенияСвойств(НастройкиОтправки, Выборка);
		
		Возврат НастройкиОтправки;
		
	Иначе
		
		Возврат Неопределено;
		
	КонецЕсли;
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Процедура ЗаполнитьВидДокументаЭДОПриОбновлении(НаборЗаписей, СоответствиеВидовДокументов, Записывать)
	
	Для Каждого Запись Из НаборЗаписей Цикл
		
		Если Запись.УдалитьВидЭД = Перечисления.ТипыДокументовЭДО.ПустаяСсылка() Тогда
			Если Запись.УдалитьТипЭД <> Перечисления.УдалитьТипыПроизвольныхДокументовЭДО.Прочее Тогда
				ТипЭДО = ТипЭДОПоТипуПроизвольногоЭД(Запись.УдалитьТипЭД);
			Иначе
				Продолжить;
			КонецЕсли;
		ИначеЕсли Запись.УдалитьВидЭД = Перечисления.ТипыДокументовЭДО.УдалитьПроизвольный Тогда
			ТипЭДО = ТипЭДОПоТипуПроизвольногоЭД(Запись.УдалитьТипЭД);
		Иначе
			ТипЭДО = Запись.УдалитьВидЭД;
		КонецЕсли;
		
		ВидДокументаЭДО = СоответствиеВидовДокументов.Получить(ТипЭДО);
		
		Если ВидДокументаЭДО <> Неопределено Тогда
			Запись.ВидДокументаЭДО = ВидДокументаЭДО;
			Записывать = Истина;
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

Функция ТипЭДОПоТипуПроизвольногоЭД(ТипЭД)
	
	Если ТипЭД = Перечисления.УдалитьТипыПроизвольныхДокументовЭДО.АктВзаимозачета Тогда
		Возврат Перечисления.ТипыДокументовЭДО.АктВзаимозачета;
	ИначеЕсли ТипЭД = Перечисления.УдалитьТипыПроизвольныхДокументовЭДО.АктВыполненныхРабот Тогда
		Возврат Перечисления.ТипыДокументовЭДО.АктВыполненныхРабот;
	ИначеЕсли ТипЭД = Перечисления.УдалитьТипыПроизвольныхДокументовЭДО.АктСверки Тогда
		Возврат Перечисления.ТипыДокументовЭДО.АктСверки;
	ИначеЕсли ТипЭД = Перечисления.УдалитьТипыПроизвольныхДокументовЭДО.Ведомость Тогда
		Возврат Перечисления.ТипыДокументовЭДО.Ведомость;
	ИначеЕсли ТипЭД = Перечисления.УдалитьТипыПроизвольныхДокументовЭДО.ГарантийноеПисьмо Тогда
		Возврат Перечисления.ТипыДокументовЭДО.ГарантийноеПисьмо;
	ИначеЕсли ТипЭД = Перечисления.УдалитьТипыПроизвольныхДокументовЭДО.Договор Тогда
		Возврат Перечисления.ТипыДокументовЭДО.Договор;
	ИначеЕсли ТипЭД = Перечисления.УдалитьТипыПроизвольныхДокументовЭДО.ДополнительноеСоглашение Тогда
		Возврат Перечисления.ТипыДокументовЭДО.ДополнительноеСоглашение;
	ИначеЕсли ТипЭД = Перечисления.УдалитьТипыПроизвольныхДокументовЭДО.КС11 Тогда
		Возврат Перечисления.ТипыДокументовЭДО.КС11;
	ИначеЕсли ТипЭД = Перечисления.УдалитьТипыПроизвольныхДокументовЭДО.КС2 Тогда
		Возврат Перечисления.ТипыДокументовЭДО.КС2;
	ИначеЕсли ТипЭД = Перечисления.УдалитьТипыПроизвольныхДокументовЭДО.КС3 Тогда
		Возврат Перечисления.ТипыДокументовЭДО.КС3;
	ИначеЕсли ТипЭД = Перечисления.УдалитьТипыПроизвольныхДокументовЭДО.Отчет Тогда
		Возврат Перечисления.ТипыДокументовЭДО.Отчет;
	ИначеЕсли ТипЭД = Перечисления.УдалитьТипыПроизвольныхДокументовЭДО.ПлатежноеПоручение Тогда
		Возврат Перечисления.ТипыДокументовЭДО.ПлатежноеПоручение;
	ИначеЕсли ТипЭД = Перечисления.УдалитьТипыПроизвольныхДокументовЭДО.ПриложениеКАкту Тогда
		Возврат Перечисления.ТипыДокументовЭДО.ПриложениеКАкту;
	ИначеЕсли ТипЭД = Перечисления.УдалитьТипыПроизвольныхДокументовЭДО.Прочее Тогда
		Возврат Перечисления.ТипыДокументовЭДО.Прочее;
	ИначеЕсли ТипЭД = Перечисления.УдалитьТипыПроизвольныхДокументовЭДО.СоглашениеОбЭДО Тогда
		Возврат Перечисления.ТипыДокументовЭДО.СоглашениеОбЭДО;
	ИначеЕсли ТипЭД = Перечисления.УдалитьТипыПроизвольныхДокументовЭДО.Спецификация Тогда
		Возврат Перечисления.ТипыДокументовЭДО.Спецификация;
	ИначеЕсли ТипЭД = Перечисления.УдалитьТипыПроизвольныхДокументовЭДО.СчетНаОплату Тогда
		Возврат Перечисления.ТипыДокументовЭДО.СчетНаОплату;
	ИначеЕсли ТипЭД = Перечисления.УдалитьТипыПроизвольныхДокументовЭДО.ТоварнаяНакладная Тогда
		Возврат Перечисления.ТипыДокументовЭДО.ТоварнаяНакладная;
	ИначеЕсли ТипЭД = Перечисления.УдалитьТипыПроизвольныхДокументовЭДО.Уведомление Тогда
		Возврат Перечисления.ТипыДокументовЭДО.Уведомление;
	КонецЕсли;
	
КонецФункции

#КонецОбласти

#КонецЕсли